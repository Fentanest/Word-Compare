name: Build Windows Executable

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-windows:
    runs-on: [self-hosted, Windows, X64, 230]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clean previous build artifacts
      shell: powershell
      run: |
        Remove-Item -Path "venv", "build", "dist" -Recurse -Force -ErrorAction SilentlyContinue

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'

    - name: Create and populate virtual environment
      shell: powershell
      run: |
        python -m venv venv
        .\venv\Scripts\python.exe -m pip install --upgrade pip
        .\venv\Scripts\pip.exe install -r requirements.txt
        .\venv\Scripts\pip.exe install pyinstaller

    - name: Setup UPX 5.1.0
      id: setup_upx
      shell: powershell
      run: |
        $version = "5.1.0"
        $upxExtractDir = "${env:TEMP}\upx"
        $upxDir = Join-Path $upxExtractDir "upx-${version}-win64"
        $upxPath = Join-Path $upxDir "upx.exe"
        $zipPath = "${env:TEMP}\upx-${version}-win64.zip"
        $downloadUrl = "https://github.com/upx/upx/releases/download/v${version}/upx-${version}-win64.zip"

        if (-not (Test-Path $upxPath)) {
          if (Test-Path $upxExtractDir) { Remove-Item -Recurse -Force $upxExtractDir }
          Write-Output "Downloading UPX $version from $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $upxExtractDir -Force
        }
        
        if (-not (Test-Path $upxPath)) {
          Write-Error "UPX executable not found at $upxPath after download/extract."
          exit 1
        }

        Write-Output "Found UPX at: $upxPath"
        echo "upx_path=$upxPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: Verify UPX version
      shell: powershell
      run: |
        Write-Output "Verifying UPX with path: ${{ steps.setup_upx.outputs.upx_path }}"
        & "${{ steps.setup_upx.outputs.upx_path }}" --version

    - name: Build executable with PyInstaller
      shell: powershell
      run: .\venv\Scripts\pyinstaller.exe main.spec

    - name: Compress executable with UPX
      shell: powershell
      run: |
        Write-Output "Compressing with UPX: ${{ steps.setup_upx.outputs.upx_path }}"
        & "${{ steps.setup_upx.outputs.upx_path }}" --best --lzma --force dist/WordCompare.exe

    - name: Upload executable as an artifact
      uses: actions/upload-artifact@v4
      with:
        name: WordCompare-Windows
        path: dist/WordCompare.exe
